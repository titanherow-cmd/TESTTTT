name: Merge Macros

on:
  workflow_dispatch:
    inputs:
      versions:
        description: 'Number of versions to create'
        required: false
        default: '6'
        type: string
      target_minutes:
        description: 'Target duration in minutes'
        required: false
        default: '35'
        type: string
      enable_chat:
        description: 'Enable chat inserts'
        required: false
        default: true
        type: boolean

jobs:
  merge:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Get next bundle ID
        id: bundle_id
        run: |
          # Find the highest bundle number
          if [ -d "output" ]; then
            HIGHEST=$(find output -name "merged_bundle_*" -type d | \
                     sed 's/.*merged_bundle_//' | \
                     sort -n | tail -1)
            NEXT=$((HIGHEST + 1))
          else
            NEXT=1
          fi
          echo "bundle_id=$NEXT" >> $GITHUB_OUTPUT
          echo "Next bundle ID: $NEXT"
      
      - name: Run merge script
        run: |
          # Build command with conditional --no-chat flag
          CMD="python merge_macros.py originals/ output/ \
            --versions ${{ inputs.versions }} \
            --target-minutes ${{ inputs.target_minutes }} \
            --bundle-id ${{ steps.bundle_id.outputs.bundle_id }}"
          
          # Add --no-chat if chat is disabled
          if [ "${{ inputs.enable_chat }}" = "false" ]; then
            CMD="$CMD --no-chat"
            echo "ðŸ”• Chat inserts DISABLED"
          else
            echo "âœ… Chat inserts ENABLED"
          fi
          
          # Execute command
          echo "Running: $CMD"
          $CMD
      
      - name: Upload merged files
        uses: actions/upload-artifact@v3
        with:
          name: merged-bundle-${{ steps.bundle_id.outputs.bundle_id }}
          path: output/merged_bundle_${{ steps.bundle_id.outputs.bundle_id }}/
          retention-days: 30
      
      - name: Commit and push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add output/
          git commit -m "Add merged bundle ${{ steps.bundle_id.outputs.bundle_id }}" || echo "No changes to commit"
          git push || echo "Nothing to push"
